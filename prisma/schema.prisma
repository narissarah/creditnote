generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "relationJoins"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// Shopify Session Storage
model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model CreditNote {
  id             String    @id @default(cuid())
  customerId     String
  customerName   String    @db.VarChar(255)
  originalAmount Decimal   @db.Decimal(10, 2)
  remainingAmount Decimal  @db.Decimal(10, 2)
  currency       String    @default("CAD")
  status         String    @default("active")
  qrCode         String?   @db.Text
  shopDomain     String
  orderId        String?
  metafieldId    String?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  redemptions    CreditRedemption[]

  @@index([shopDomain, status])
  @@index([customerId])
  @@index([orderId])
  @@index([metafieldId])
  @@map("credit_notes")
}

model CreditRedemption {
  id           String      @id @default(cuid())
  creditNoteId String
  creditNote   CreditNote  @relation(fields: [creditNoteId], references: [id])
  orderId      String
  amount       Decimal     @db.Decimal(10, 2)
  posTerminal  String?
  createdAt    DateTime    @default(now())

  @@index([creditNoteId])
  @@index([orderId])
  @@map("credit_redemptions")
}


model ShopSettings {
  id                String    @id @default(cuid())
  shopDomain        String    @unique
  currency          String    @default("USD")
  creditPrefix      String    @default("CN-")
  autoExpireDays    Int?      @default(365)
  emailNotifications Boolean  @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("shop_settings")
}